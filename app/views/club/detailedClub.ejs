<!DOCTYPE html>
<html>
	<head>
		<% include ../layout/head %>
		<style>
			.table tbody>tr>td {
				vertical-align: middle;
			}
			img.img-circle {
				margin: 0 auto;
			}
			th, td {
				text-align: center;
			}
			td > a {
				color: #008CBA;
				cursor: pointer;
			}
			td > a:hover {
				text-decoration: underline;
			}
			.playerName {
				/*width: 50px;*/
			}
			.glyphicon-remove, .glyphicon-pencil{
				font-size: 1.2em; /* size lager */
				cursor: pointer;
			}
			.bootstrap-select > .btn {
				/* 이거 bootstrap default select box 맞춰주는거야 꼭필요*/
				padding: 6px 12px !important;
			}
		</style>

	</head>
	<body>
		<% include ../layout/navbar %>
		<div class="container">

			<% include ../layout/joinedUser %>

			<% include ../layout/alertLeague %>

			<div class="row">
				<img id="teamLogo" class="center-block" src="/images/team/<%= club.teamId %>/image140.jpg">
				<h3 class="text-center"><%= club.teamName %></h3>
				<input id="clubNumber" type="hidden" value="<%= club.clubId %>">
				<input id="playerId" type="hidden" value="<%= user.playerId %>">
				<p class="text-muted text-center">리더 : <%= club.leaderName%> </p>
				<!-- <p class="text-muted text-center">승률 : 30%(총 20경기 4승 3무 3패) !!더미</p> -->

				<%	if (league.status == 'playing') { %>
					<p class="text-center">
						<button id="getFormation" class="btn btn-info btn-lg">Formation</button>
					</p>
				<% } %>
			</div>

			<%	if (league.status == 'before') { %>
				<% if (user.userId === club.leaderId) { %>
					<% include editPlayer %>

				<% }else { %>
					<% include playerStat %>
				<% } %>

			<% }else { %>
				<% include playerStat %>
			<% } %>


			<% include ../layout/playerLim %>

			<% console.log("club     :   " , club); %>
			<% console.log("league     :   " , league); %>

			<%	if (league.status == 'before') { %>

				<% if (user.clubId === club.clubId && !(user.userId === club.leaderId)) { %>

					<!-- <button type="button" class="btn btn-info btn-lg btn-block" data-toggle="modal" data-target=".updatePosition">포지션 수정 </button>
					<button type="button" class="btn btn-info btn-lg btn-block" data-toggle="modal" data-target=".squadNumber">스쿼드넘버 수정 </button> -->
					<button type="button" class="btn btn-danger btn-lg btn-block" id="signoutClub">이 클럽 탈퇴 </button>

					<div class="bs-callout">
						<h5>리그가 시작되면 탈퇴할 수 없습니다.</h5>
					</div>

				<% }else if (!(user.userId === club.leaderId)) { %>
					<a type="button" class="btn btn-success btn-lg btn-block" data-toggle="modal" data-target="#clubId<%= club.clubId %>">
						이 클럽에 가입
					</a>
				<% } %>
			<%	}	/* end before */%>

			<% include ../layout/footer %>

		</div> <!-- /container -->


		<!-- Bootstrap core JavaScript
		================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<% include ../layout/defaultPlugins %>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/js/bootstrapValidator.min.js"></script>
		<script src="/js/bootstrap-select.js"></script>
		<script>
			//포메이션으로 이동
			$("#getFormation").click( function (e) {
				location.href = location.origin +
								"/league/" +
								location.pathname.split("/")[2] +
								"/formation/" +
								location.pathname.split("/")[4];
			})

			$("#deleteClub").click(function(e) {

				$.ajax({
					type        : 'delete',
					async       : true,
					url         : '/club',
					data        : {clubId: $("#clubNumber").val()},
					beforeSend  : function() {
							 $('#ajax_load_indicator').show().fadeIn('fast');
					},
					success     : function(data) {
						console.log('success data : ' + data);
						console.log(data.redirect);
						alert( "success" );
						window.location.href = data.redirect;
					},
					error       : function(data, status, err) {
						console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
					},
					complete    : function() {
						$('#ajax_load_indicator').fadeOut();
					}
				});

			});


			$("#signoutClub").click(function(e) {
				$.ajax({
					type        : 'delete',
					async       : true,
					crossDomain : true,
					url         : '/signoutClub',
					data        : {playerId: $("#playerId").val()},
					beforeSend  : function() {
							 $('#ajax_load_indicator').show().fadeIn('fast');
					},
					success     : function(data) {
						console.log('success data : ' + data);
						console.log(data);
						console.log(data.redirect);
						alert( "success" );
						window.location.href = data.redirect;
					},
					error       : function(data, status, err) {
						console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
					},
					complete    : function() {
						$('#ajax_load_indicator').fadeOut();
					}
				});

			});

			//click glyphicon-pencil
			$('.glyphicon-pencil').click(function (e) {
				var playerId 	  = $(this).attr('data-player-id'),
					playerName 	  = $(this).attr('data-player-name'),
					value 		  = $(this).attr('value'),
					modal 		  = $(this).attr('data-target');

				//set player
				$(modal).find('[name="playerId"]').val(playerId);
				$(modal).find('.modal-title').children('strong').text(playerName);
				$(modal).find('.text-muted').text(value);

			});

			$('#positionForm').submit(function (e){

				console.log('success submit');
				// Prevent form submission
				e.preventDefault();

				var $form = $(e.target);

				$.ajax({
					type        : 'PUT',
					async       : true,
					url         : "/position",
					data        : $form.serialize(),
					success     : function(data) {
						switch (data.message) {

							case "success" :
								alert("포지션이 변경되었습니다.");
								location.reload(); break;

							case "fail" :

								alert('실패했습니다.'); break;
						}

					},
					error       : function(data, status, err) {
						console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
					}
				});

			});

			$('#squadNumberForm').submit(function (e){

				console.log('success submit');
				// Prevent form submission
				e.preventDefault();

				var $form = $(e.target);

				$.ajax({
					type        : 'PUT',
					async       : true,
					url         : "/squadNumber",
					data        : $form.serialize(),
					success     : function(data) {
						switch (data.message) {

							case "success" :
								alert("스쿼드넘버가 변경되었습니다.");
								location.reload(); break;

							case "fail" :

								alert('실패했습니다.'); break;
						}

					},
					error       : function(data, status, err) {
						console.log("error forward : "+data);
							alert('서버와의 통신이 실패했습니다.');
					}
				});

			});

			$("#outLeague").click(function (e) {

				console.log('out click???');

				var url = "/league/" + location.pathname.split("/")[2] + "/outLeague";

				$.ajax({
					type        : 'delete',
					async       : true,
					url         : url,
					data 		: {clubId : location.pathname.split("/")[4]},
					beforeSend  : function() {
						NProgress.inc();
					},
					success     : function(data) {
						console.log('통신성공');
					},
					error       : function(data, status, err) {
						console.log("error forward : "+data);
						alert('서버와의 통신이 실패했습니다.');
					},
					complete    : function (xhr, status) {
						NProgress.done();
						location.href = location.origin + "/league/" + location.pathname.split("/")[2] + "/match";
					}
				});
			});

			$('.glyphicon-remove.text-danger').click(function (e) {

				var playerName = $(this).attr('data-player-name'),
					playerId   = $(this).attr('data-player-id');

				$("#outClub").attr('data-player-id', playerId)
				$(".confirmPlayerOutModal").find('center > h4').text(playerName);
				$(".confirmPlayerOutModal").modal('show');
			});


			$("#outClub").click(function (e) {

				var url = '/signoutClub/' + $(this).attr('data-player-id');

				$.ajax({
					type        : 'delete',
					async       : true,
					url         : url,
					beforeSend  : function() {
						NProgress.inc();
					},
					success     : function(data) {
						console.log('통신성공');
					},
					error       : function(data, status, err) {
						console.log("error forward : "+ data);
						alert('서버와의 통신이 실패했습니다.');
					},
					complete    : function (xhr, status) {
						NProgress.done();
						alert('제외되었습니다.');
						location.reload();
					}
				});
			});

			//insert default image
			$(".img-circle").each(function () {
				if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
					// image was broken, replace with your new image
					this.src = '/images/default/defaultUser.png';
				}
			});

			$("#teamLogo").is(function () {
				if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
					// image was broken, replace with your new image
					this.src = '/images/default/defaultClub.png';
				}
			});


			//구지 첨부터 특정포지션 설정해놓는게 낫지 않을까???
			// $('#updatePosition')
				// .find('[name="position"]')
				//     .selectpicker()
				//     .change(function(e) {
				//         // revalidate the language when it is changed
				//         $('#updatePosition').bootstrapValidator('revalidateField', 'position');
				//     })
				//     .end()
				// .bootstrapValidator({
				//     excluded: ':disabled',
				//     feedbackIcons: {
				//         valid: 'glyphicon glyphicon-ok',
				//         invalid: 'glyphicon glyphicon-remove',
				//         validating: 'glyphicon glyphicon-refresh'
				//     },
				//     fields: {
				//         language: {
				//             validators: {
				//                 notEmpty: {
				//                     message: 'Please select your native language.'
				//                 }
				//             }
				//         }
				//     }
				// });


			$('#playerForm')
		        .find('[name="position"]')
		            .selectpicker()
		            .change(function(e) {
		                // revalidate the language when it is changed
		                $('#bootstrapSelectForm').bootstrapValidator('revalidateField', 'position');
		            })
		            .end()
		        .find('[name="squadNumber"]')
		            .selectpicker()
		            .change(function(e) {
		                // revalidate the language when it is changed
		                $('#bootstrapSelectForm').bootstrapValidator('revalidateField', 'squadNumber');
		            })
		            .end()
				.bootstrapValidator({
					// To use feedback icons, ensure that you use Bootstrap v3.1.0 or later
					live : 'submitted',
		            excluded: ':disabled',
					feedbackIcons: {
						valid: 'glyphicon glyphicon-ok',
						invalid: 'glyphicon glyphicon-remove',
						validating: 'glyphicon glyphicon-refresh'
					},
					fields: {
						lastName: {
							feedbackIcons: 'false',
							// message: 'The username is not valid',
							validators: {
								notEmpty: {
									message: '성을 적어주세요.'
								},
								stringLength: {
									// min: 6,
									max: 20,
									message: '너무 길어요.'
								},
								regexp: {
									regexp: /^[ㄱ-ㅎ가-힣]+$/,
									message: '한글로 입력해주세요.'
								}
							}
						},
						firstName: {
							feedbackIcons: 'false',
							// message: 'The username is not valid',
							validators: {
								notEmpty: {
									message: '이름을 적어 주세요.'
								},
								stringLength: {
									// min: 6,
									max: 20,
									message: '너무 길어요.'
								},
								regexp: {
									regexp: /^[ㄱ-ㅎ가-힣]+$/,
									message: '한글로 입력해주세요.'
								}
							}
						},
						email: {
							feedbackIcons: 'false',
							validators: {
								notEmpty: {
									message: '이메일을 적어주세요.'
								},
								emailAddress: {
									message: '이메일 형식에 맞게 적어주세요.'
								}
							}
						},
						birthday: {
							feedbackIcons: 'false',
							validators: {
								notEmpty: {
									message: '생일을 입력해 주세요.'
								},
								date: {
									format: 'YYYY/MM/DD',
									message: '형식에 맞게 입력해 주세요.'
								}
							}
						},
		                position: {
		                	feedbackIcons: 'false',
		                    validators: {
		                        notEmpty: {
		                            message: '포지션을 선택해야합니다.'
		                        }
		                    }
		                },
		                squadNumber: {
		                	feedbackIcons: 'false',
		                    validators: {
		                        notEmpty: {
		                            message: '등번호를 선택해야합니다.'
		                        }
		                    }
		                }
					}
				})
		        .on('success.form.bv', function(e) {
		            // Prevent form submission
		            e.preventDefault();

		            // Get the form instance
		            var $form = $(e.target);

		            // Get the BootstrapValidator instance
		            var bv = $form.data('bootstrapValidator');

		            // Use Ajax to submit form data
		            $.post($form.attr('action'), $form.serialize(), function(result) {
		            	if (result.message == 'existed') {
		            		html = '<div class="alert alert-danger"><button type="button" class="close" data-dismiss="alert">×</button><strong>오 이런!</strong> 중복된 이메일이군요.</div>'

	            			$('#playerForm').find('.form-group').last().after(html);
	            			$('#playerForm').find('[name="email"]').parent().addClass('has-error');

							setTimeout(function() {
								$(".alert-danger").fadeTo(500, 0).slideUp(500, function(){
									$(this).remove();
								});
							}, 5000)


		            	}else {
		            		location.reload();
		            	}

		            }, 'json');
		        });


		</script>

	</body>
</html>